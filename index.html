<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Aprende Ajedrez Jugando</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f0f9ff;
            overscroll-behavior: none;
        }
        h1, h2, h3 {
            font-family: 'Fredoka One', cursive;
        }
        .chess-board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            width: 90vw;
            height: 90vw;
            max-width: 500px;
            max-height: 500px;
            border: 10px solid #8b5cf6;
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }
        .square {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: clamp(2rem, 8vw, 3.5rem);
            position: relative;
            cursor: pointer;
            overflow: hidden;
        }
        .square.light { background-color: #f3e8ff; }
        .square.dark { background-color: #c4b5fd; }
        .piece {
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            cursor: pointer;
            line-height: 1;
            user-select: none;
        }
        .piece.selected { 
            filter: drop-shadow(0 0 8px #f59e0b); 
            transform: scale(1.1); 
        }
        .highlight { background-color: rgba(250, 204, 21, 0.7) !important; border: 3px dashed #f59e0b; }
        .goal-square::after {
            content: 'â˜…';
            position: absolute;
            font-size: 2.5rem;
            color: #f59e0b;
            text-shadow: 0 0 5px white;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }
        .control-button { transition: all 0.2s ease-in-out; }
        .control-button:hover:not(.disabled) { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .control-button.active { background-color: #8b5cf6 !important; color: white !important; }
        .control-button.disabled {
            cursor: not-allowed;
            background-color: #e5e7eb;
            opacity: 0.7;
        }
        #gemini-output { min-height: 120px; }
        .turn-indicator {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: bold;
            color: white;
            transition: background-color 0.3s;
        }
        .nav-piece {
            font-size: 2rem;
            color: #a78bfa;
            transition: all 0.3s ease;
        }
        .nav-piece.active {
            color: #7c3aed;
            transform: scale(1.2);
        }
        .nav-piece.completed {
            color: #22c55e;
        }
        .lesson-step {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #d1d5db;
            transition: all 0.3s ease;
        }
        .lesson-step.active {
            background-color: #7c3aed;
            transform: scale(1.5);
        }
    </style>
</head>
<body class="bg-blue-50 text-gray-800 flex flex-col items-center min-h-screen p-4">

    <div id="auth-container" class="absolute top-4 right-4"></div>

    <div class="text-center mb-4 mt-4">
        <svg class="mx-auto h-32 w-auto" viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect width="120" height="120" fill="white"/>
            <path d="M85.2997 50.8591C85.2997 51.7445 84.5819 52.4623 83.6965 52.4623V52.4623C82.7486 52.4623 82.0077 53.2803 82.1012 54.2235L85.613 89.6595C85.8143 91.6903 87.5226 93.2377 89.5634 93.2377H90.9847C92.3922 93.2377 93.5331 94.3786 93.5331 95.786V95.786C93.5331 97.1934 92.3922 98.3344 90.9847 98.3344H26.6849C25.2775 98.3344 24.1366 97.1934 24.1366 95.786V95.786C24.1366 94.3786 25.2775 93.2377 26.6849 93.2377H28.0146C30.0016 93.2377 31.6672 91.7358 31.872 89.7593L35.5751 54.0176C35.6612 53.1858 35.0088 52.4623 34.1726 52.4623V52.4623C33.3939 52.4623 32.7626 51.831 32.7626 51.0523V49.9139C32.7626 48.5065 33.9035 47.3656 35.3109 47.3656H82.7513C84.1588 47.3656 85.2997 48.5065 85.2997 49.9139V50.8591Z" fill="#FBD51D"/>
            <ellipse cx="46.8767" cy="68.7334" rx="3.13656" ry="4.11674" fill="#221E54"/>
            <ellipse cx="68.8326" cy="68.7334" rx="3.13656" ry="4.11674" fill="#221E54"/>
            <path d="M52.9537 74.2224C54.7181 76.8362 59.2269 80.4955 63.1476 74.2224" stroke="#221E55" stroke-width="2" stroke-linecap="round"/>
            <path d="M60.6201 16C64.486 16.0001 67.6201 19.1341 67.6201 23V30.1143H72.6826V22.7002C72.6828 18.9999 75.6825 16.0002 79.3828 16C83.0833 16 86.0838 18.9997 86.084 22.7002V38.7969C86.084 42.6628 82.9498 45.7967 79.084 45.7969H38.5859C34.7199 45.7969 31.5859 42.6629 31.5859 38.7969V22.7002C31.5861 18.9999 34.5858 16.0002 38.2861 16C41.9866 16 44.9871 18.9997 44.9873 22.7002V30.1143H49.752V23C49.752 19.134 52.886 16 56.752 16H60.6201Z" fill="#FBD51D"/>
            <path d="M21 105C21 102.185 23.282 99.9031 26.0969 99.9031H93.533C96.348 99.9031 98.63 102.185 98.63 105V105H21V105Z" fill="#F6DB3D"/>
        </svg>
        <h1 class="text-4xl md:text-5xl text-purple-600 -mt-4">Â¡Aprende Ajedrez!</h1>
    </div>

    <!-- Selector de Modo -->
    <div id="mode-selector" class="flex flex-wrap justify-center gap-3 mb-4">
        <button data-mode="lessons" class="control-button bg-white p-3 rounded-lg shadow-md text-xl">Aprender Piezas</button>
        <button data-mode="challenges" id="challenges-mode-button" class="control-button bg-white p-3 rounded-lg shadow-md text-xl">
            Retos
        </button>
        <button data-mode="practice" id="practice-mode-button" class="control-button bg-white p-3 rounded-lg shadow-md text-xl relative">
            Practicar con IA
            <span id="lock-icon-practice" class="absolute -top-2 -right-2 text-2xl">ðŸ”’</span>
        </button>
    </div>
    
    <!-- Contenedor de Lecciones -->
    <div id="lessons-container" class="hidden w-full flex-col items-center">
        <div id="lesson-progress-nav" class="flex justify-center items-center gap-2 md:gap-4 p-2 bg-purple-100 rounded-full mb-4 w-full max-w-md"></div>
    </div>
    
    <!-- Contenedor de Retos -->
    <div id="challenges-container" class="hidden w-full flex-col items-center">
         <div id="challenge-nav" class="flex items-center justify-center gap-4 mb-4">
            <button id="prev-challenge-button" class="control-button bg-yellow-400 p-2 rounded-full shadow-md text-2xl">â—€</button>
            <div id="challenge-day-display" class="text-xl font-bold text-purple-700"></div>
            <button id="next-challenge-button" class="control-button bg-yellow-400 p-2 rounded-full shadow-md text-2xl">â–¶</button>
         </div>
    </div>

    <!-- Contenedor de PrÃ¡ctica -->
    <div id="practice-container" class="hidden w-full flex-col items-center">
         <button id="new-puzzle-button" class="control-button bg-indigo-500 text-white p-3 rounded-lg shadow-md text-xl mb-4">Nuevo DesafÃ­o</button>
    </div>

    <!-- Mensaje de la lecciÃ³n/juego -->
    <div id="message-area" class="text-center mb-4 h-12">
        <h2 class="text-2xl text-purple-700"></h2>
    </div>

    <div id="board" class="chess-board mb-4"></div>
    
    <div id="game-info" class="text-center h-10 mb-4"></div>

    <!-- Contenedor para la respuesta de Gemini -->
    <div id="gemini-output" class="mt-2 p-4 bg-white rounded-xl shadow-lg w-full max-w-xl text-center hidden flex-col items-center justify-center">
        <div id="gemini-loading" class="hidden">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500 mx-auto"></div>
            <p class="mt-2 text-gray-600">La IA estÃ¡ pensando...</p>
        </div>
        <div id="gemini-content" class="text-gray-700 text-lg"></div>
    </div>

    <!-- DiÃ¡logo de finalizaciÃ³n de lecciÃ³n -->
    <div id="completion-dialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl text-center transform scale-95 transition-transform w-full max-w-sm relative">
            <button id="close-dialog-button" class="absolute top-2 right-4 text-gray-500 hover:text-gray-800 text-4xl leading-none">&times;</button>
            <h3 id="dialog-title" class="text-3xl font-bold text-purple-600 mb-4">Â¡Genial!</h3>
            <p id="dialog-message" class="text-lg text-gray-700 mb-6">Has completado la lecciÃ³n.</p>
            <div id="dialog-buttons" class="flex flex-col gap-3"></div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- ELEMENTOS DEL DOM ---
        const modeSelector = document.getElementById('mode-selector');
        const lessonsContainer = document.getElementById('lessons-container');
        const practiceContainer = document.getElementById('practice-container');
        const challengesContainer = document.getElementById('challenges-container');
        const newPuzzleButton = document.getElementById('new-puzzle-button');
        const boardEl = document.getElementById('board');
        const messageArea = document.getElementById('message-area').querySelector('h2');
        const gameInfo = document.getElementById('game-info');
        const geminiOutput = document.getElementById('gemini-output');
        const geminiLoading = document.getElementById('gemini-loading');
        const geminiContent = document.getElementById('gemini-content');
        const lessonProgressNav = document.getElementById('lesson-progress-nav');
        const completionDialog = document.getElementById('completion-dialog');
        const dialogTitle = document.getElementById('dialog-title');
        const dialogMessage = document.getElementById('dialog-message');
        const dialogButtons = document.getElementById('dialog-buttons');
        const authContainer = document.getElementById('auth-container');
        const practiceModeButton = document.getElementById('practice-mode-button');
        const challengesModeButton = document.getElementById('challenges-mode-button');
        const lockIconPractice = document.getElementById('lock-icon-practice');
        const prevChallengeButton = document.getElementById('prev-challenge-button');
        const nextChallengeButton = document.getElementById('next-challenge-button');
        const challengeDayDisplay = document.getElementById('challenge-day-display');
        
        // --- ESTADO GLOBAL ---
        let currentMode = 'lessons';
        let game = null;
        let selectedSquare = null;
        let auth = null;
        let currentUser = null;
        let pendingActionAfterLogin = null;
        
        // --- LÃ“GICA DE LECCIONES ---
        let lessonState = { piece: null, type: null, inProgress: false, pieceCoords: null };
        const pieceOrder = ['pawn', 'knight', 'bishop', 'rook', 'queen', 'king'];
        const lessonPieces = { pawn: { name: 'PeÃ³n', symbol: 'â™™' }, knight: { name: 'Caballo', symbol: 'â™˜' }, bishop: { name: 'Alfil', symbol: 'â™—' }, rook: { name: 'Torre', symbol: 'â™–' }, queen: { name: 'Reina', symbol: 'â™•' }, king: { name: 'Rey', symbol: 'â™”' } };
        const lessons = { pawn: { move: [{ piece: [4, 1], highlights: [[4, 2], [4, 3]] }], capture: [{ piece: [4, 4], enemy: [3, 5], highlights: [[3, 5]] }] }, knight: { move: [{ piece: [1, 0], highlights: [[0, 2], [2, 2], [3,1]] }], capture: [{ piece: [4, 4], enemy: [5, 6], highlights: [[5, 6]] }] }, bishop: { move: [{ piece: [2, 0], highlights: [[0, 2], [1, 1], [3, 1], [4, 2], [5, 3], [6, 4], [7, 5]] }], capture: [{ piece: [2, 2], enemy: [5, 5], highlights: [[5, 5]] }] }, rook: { move: [{ piece: [0, 0], highlights: [[0, 7], [7, 0]] }], capture: [{ piece: [0, 0], enemy: [0, 5], highlights: [[0, 5]] }] }, queen: { move: [{ piece: [3, 3], highlights: [[3,0],[0,3],[5,5],[1,5]] }], capture: [{ piece: [3, 3], enemy: [7, 7], highlights: [[7, 7]] }] }, king: { move: [{ piece: [4, 0], highlights: [[3,0],[3,1],[4,1],[5,1],[5,0]] }], capture: [{ piece: [4, 4], enemy: [5, 5], highlights: [[5, 5]] }] } };

        // --- LÃ“GICA DE RETOS ---
        let challengeState = { inProgress: false, currentChallengeIndex: 0, maxChallengeIndex: 0 };
        const challenges = [
            { fen: '8/8/8/8/8/2N5/8/8 w - - 0 1', goal: 'Lleva el caballo a f6', goalSquare: 'f6' },
            { fen: '8/8/8/8/8/8/8/R7 w - - 0 1', goal: 'Lleva la torre a h8', goalSquare: 'h8' },
            { fen: '8/8/8/8/8/8/1B6/8 w - - 0 1', goal: 'Lleva el alfil a g7', goalSquare: 'g7'},
            { fen: '8/8/8/8/8/8/8/Q7 w - - 0 1', goal: 'Lleva la reina a e5', goalSquare: 'e5'},
            { fen: '4K3/8/8/8/8/8/8/8 w - - 0 1', goal: 'Lleva el rey a c6', goalSquare: 'c6'}
        ];

        // --- LÃ“GICA DE PUZZLES ---
        const puzzles = [ { fen: 'r1bqkbnr/pppp1ppp/2n5/4p3/4P3/5N2/PPPP1PPP/RNBQKB1R w KQkq - 2 3', goal: 'Juegan las blancas. Â¡Desarrolla tus piezas!' }, { fen: '4k3/8/8/8/8/8/4P3/4K3 w - - 0 1', goal: 'Juegan las blancas. Â¡Intenta coronar el peÃ³n!' } ];
        const pieceSymbols = { w: { p: 'â™™', r: 'â™–', n: 'â™˜', b: 'â™—', q: 'â™•', k: 'â™”' }, b: { p: 'â™Ÿ', r: 'â™œ', n: 'â™ž', b: 'â™', q: 'â™›', k: 'â™š' } };

        // --- FUNCIONES DE AUTENTICACIÃ“N ---
        function setupAuth() {
            try {
                const firebaseConfig = {
                    apiKey: "YOUR_API_KEY",
                    authDomain: "YOUR_AUTH_DOMAIN",
                    projectId: "YOUR_PROJECT_ID",
                    storageBucket: "YOUR_STORAGE_BUCKET",
                    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
                    appId: "YOUR_APP_ID"
                };
                // const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);

                onAuthStateChanged(auth, user => {
                    currentUser = user;
                    updateAuthUI(user);
                    updatePremiumFeaturesAccess(user);
                    if (user && pendingActionAfterLogin) {
                        pendingActionAfterLogin();
                        pendingActionAfterLogin = null;
                    }
                });
            } catch (e) {
                console.error("Firebase initialization error: Make sure to replace the placeholder config with your actual Firebase project config.", e);
                authContainer.innerHTML = `<p class="text-red-500">Error de Auth</p>`;
            }
        }

        function updateAuthUI(user) {
            if (user) {
                authContainer.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="text-gray-700">Hola, ${user.displayName.split(' ')[0]}</span>
                        <button id="logout-button" class="control-button bg-red-500 text-white px-3 py-1 rounded-lg text-sm">Salir</button>
                    </div>`;
                document.getElementById('logout-button').addEventListener('click', () => signOut(auth));
            } else {
                authContainer.innerHTML = `<button id="login-button" class="control-button bg-blue-500 text-white px-4 py-2 rounded-lg">Iniciar SesiÃ³n con Google</button>`;
                document.getElementById('login-button').addEventListener('click', signInWithGoogle);
            }
        }
        
        function updatePremiumFeaturesAccess(user) {
            const isUnlocked = !!user;
            practiceModeButton.classList.toggle('disabled', !isUnlocked);
            lockIconPractice.style.display = isUnlocked ? 'none' : 'block';

            if (!isUnlocked && currentMode === 'practice') {
                document.querySelector('[data-mode="lessons"]').click();
            }
        }

        function signInWithGoogle() {
            if (!auth) { console.error("Firebase Auth is not initialized."); return; }
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(error => console.error("Google sign-in error", error));
        }

        // --- FUNCIONES DEL TABLERO ---
        function createBoard() {
            boardEl.innerHTML = '';
            for (let row = 7; row >= 0; row--) {
                for (let col = 0; col < 8; col++) {
                    const squareEl = document.createElement('div');
                    squareEl.classList.add('square', (row + col) % 2 === 0 ? 'dark' : 'light');
                    squareEl.dataset.square = `${String.fromCharCode(97+col)}${row+1}`;
                    squareEl.dataset.col = col;
                    squareEl.dataset.row = row;
                    boardEl.appendChild(squareEl);
                }
            }
        }

        function drawBoardFromFen(fen) {
            const tempGame = new Chess(fen);
            boardEl.querySelectorAll('.square').forEach(squareEl => {
                const piece = tempGame.get(squareEl.dataset.square);
                squareEl.innerHTML = '';
                if (piece) {
                    const pieceEl = document.createElement('span');
                    pieceEl.classList.add('piece');
                    pieceEl.textContent = pieceSymbols[piece.color][piece.type];
                    squareEl.appendChild(pieceEl);
                }
            });
        }

        function clearBoard() {
            boardEl.querySelectorAll('.square').forEach(sq => {
                sq.innerHTML = '';
                sq.classList.remove('highlight', 'selected', 'goal-square');
            });
        }

        // --- LÃ“GICA DE LECCIONES ---
        function updateLessonNav() {
            lessonProgressNav.innerHTML = '';
            const currentPieceIndex = pieceOrder.indexOf(lessonState.piece);
            pieceOrder.forEach((pieceKey, index) => {
                const navItem = document.createElement('div');
                navItem.className = 'flex flex-col items-center gap-1';
                const pieceEl = document.createElement('div');
                pieceEl.className = 'nav-piece';
                pieceEl.textContent = lessonPieces[pieceKey].symbol;
                if (lessonState.piece) {
                    if (index < currentPieceIndex) pieceEl.classList.add('completed');
                    else if (index === currentPieceIndex) pieceEl.classList.add('active');
                }
                navItem.appendChild(pieceEl);
                if (lessonState.piece && index === currentPieceIndex) {
                    const stepsContainer = document.createElement('div');
                    stepsContainer.className = 'flex gap-1.5';
                    const types = ['move', 'capture'];
                    types.forEach((type, typeIndex) => {
                        if (lessons[pieceKey][type]) {
                            const step = document.createElement('div');
                            step.className = 'lesson-step';
                            if (typeIndex <= types.indexOf(lessonState.type)) {
                                step.classList.add('active');
                            }
                            stepsContainer.appendChild(step);
                        }
                    });
                    navItem.appendChild(stepsContainer);
                }
                lessonProgressNav.appendChild(navItem);
            });
        }

        function loadLesson() {
            clearBoard();
            lessonState.inProgress = true;
            selectedSquare = null;
            updateLessonNav();
            const lessonData = lessons[lessonState.piece][lessonState.type][0];
            lessonState.pieceCoords = lessonData.piece;
            const pieceSquare = document.querySelector(`[data-col='${lessonData.piece[0]}'][data-row='${lessonData.piece[1]}']`);
            pieceSquare.innerHTML = `<span class="piece">${lessonPieces[lessonState.piece].symbol}</span>`;
            if (lessonData.enemy) {
                const enemySquare = document.querySelector(`[data-col='${lessonData.enemy[0]}'][data-row='${lessonData.enemy[1]}']`);
                enemySquare.innerHTML = `<span class="piece">â™Ÿ</span>`;
            }
            lessonData.highlights.forEach(([col, row]) => {
                document.querySelector(`[data-col='${col}'][data-row='${row}']`).classList.add('highlight');
            });
            const lessonTypeName = {move: 'movimiento', capture: 'captura'}[lessonState.type];
            messageArea.textContent = `LecciÃ³n del ${lessonPieces[lessonState.piece].name}: ${lessonTypeName}`;
        }

        function handleLessonMove(fromSquare, toSquare) {
            toSquare.innerHTML = fromSquare.innerHTML;
            fromSquare.innerHTML = '';
            lessonState.inProgress = false;
            document.querySelectorAll('.highlight').forEach(sq => sq.classList.remove('highlight'));
            setTimeout(showCompletionDialog, 750);
        }

        function showCompletionDialog() {
            const currentPieceIndex = pieceOrder.indexOf(lessonState.piece);
            let nextLessonHandler;
            let title, message;
            const isFinalLesson = (lessonState.piece === 'king' && lessonState.type === 'capture');

            dialogButtons.innerHTML = '';

            if (isFinalLesson) {
                title = 'Â¡FELICIDADES!';
                message = 'Â¡Has completado todas las lecciones! Inicia sesiÃ³n para desbloquear el modo de PrÃ¡ctica con IA.';
                nextLessonHandler = () => resetLessonsView();
                
                const loginButton = document.createElement('button');
                loginButton.className = 'control-button bg-blue-500 text-white p-3 rounded-lg shadow-md text-xl w-full';
                loginButton.textContent = 'Iniciar SesiÃ³n para Jugar';
                loginButton.onclick = () => {
                    pendingActionAfterLogin = () => { document.querySelector('[data-mode="practice"]').click(); };
                    signInWithGoogle();
                    completionDialog.classList.add('hidden');
                };
                dialogButtons.appendChild(loginButton);
            } else {
                if (lessonState.type === 'move') {
                    title = 'Â¡Muy bien!';
                    message = `Â¡Aprendiste a mover el ${lessonPieces[lessonState.piece].name}! Ahora, a capturar.`;
                    nextLessonHandler = () => { lessonState.type = 'capture'; loadLesson(); };
                } else {
                    const nextPiece = pieceOrder[currentPieceIndex + 1];
                    title = 'Â¡Excelente!';
                    message = `Â¡Ya dominas el ${lessonPieces[lessonState.piece].name}! Â¿Listo para la siguiente pieza?`;
                    nextLessonHandler = () => { lessonState.piece = nextPiece; lessonState.type = 'move'; loadLesson(); };
                }
                const continueButton = document.createElement('button');
                continueButton.className = 'control-button bg-green-500 text-white p-3 rounded-lg shadow-md text-xl w-full';
                continueButton.textContent = 'Continuar';
                continueButton.onclick = () => {
                    completionDialog.classList.add('hidden');
                    nextLessonHandler();
                };
                dialogButtons.appendChild(continueButton);
            }
            
            dialogTitle.textContent = title;
            dialogMessage.textContent = message;

            const closeButton = document.getElementById('close-dialog-button');
            const newCloseButton = closeButton.cloneNode(true);
            closeButton.parentNode.replaceChild(newCloseButton, closeButton);
            
            newCloseButton.addEventListener('click', () => {
                completionDialog.classList.add('hidden');
                if (!isFinalLesson) nextLessonHandler();
            }, { once: true });

            completionDialog.classList.remove('hidden');
        }
        
        function resetLessonsView() {
            clearBoard();
            messageArea.textContent = 'Â¡Has completado el entrenamiento!';
            lessonState.piece = null;
            lessonState.type = null;
            updateLessonNav();
        }

        // --- LÃ“GICA DE RETOS ---
        function getDaysSinceStart() {
            const startDate = new Date('2024-01-01');
            const today = new Date();
            const diffTime = Math.abs(today - startDate);
            return Math.floor(diffTime / (1000 * 60 * 60 * 24));
        }

        function loadChallenge(index) {
            clearBoard();
            challengeState.inProgress = true;
            challengeState.currentChallengeIndex = index;
            const challenge = challenges[index % challenges.length]; // Loop challenges if we run out
            challengeState.currentChallenge = challenge;
            const { fen, goal, goalSquare } = challenge;
            game = new Chess(fen);
            
            drawBoardFromFen(fen);
            messageArea.textContent = goal;

            document.querySelector(`[data-square="${goalSquare}"]`).classList.add('goal-square');
            updateChallengeNav();
        }

        function updateChallengeNav() {
            const day = challengeState.currentChallengeIndex + 1;
            challengeDayDisplay.textContent = `Reto del DÃ­a #${day}`;
            prevChallengeButton.disabled = (day <= 1);
            nextChallengeButton.disabled = (day > challengeState.maxChallengeIndex);
        }

        function handleChallengeMove(fromSquare, toSquare) {
            const { goalSquare } = challengeState.currentChallenge;
            const fromId = fromSquare.dataset.square;
            const toId = toSquare.dataset.square;
            
            const move = game.move({ from: fromId, to: toId });

            if (move) {
                let fenParts = game.fen().split(' ');
                fenParts[1] = 'w';
                game.load(fenParts.join(' '));
                
                drawBoardFromFen(game.fen());
                document.querySelector(`[data-square="${goalSquare}"]`).classList.add('goal-square');

                if (toId === goalSquare) {
                    challengeState.inProgress = false;
                    setTimeout(() => {
                        dialogTitle.textContent = 'Â¡Reto Completado!';
                        dialogMessage.textContent = 'Â¡Lo has conseguido! Â¿Quieres probar otro reto?';
                        dialogButtons.innerHTML = `<button id="dialog-next-challenge" class="control-button bg-yellow-500 text-white p-3 rounded-lg shadow-md text-xl w-full">Siguiente Reto</button>`;
                        completionDialog.classList.remove('hidden');
                        const nextChallengeBtn = document.getElementById('dialog-next-challenge');
                        if(nextChallengeBtn) {
                            nextChallengeBtn.onclick = () => {
                                completionDialog.classList.add('hidden');
                                if (challengeState.currentChallengeIndex < challengeState.maxChallengeIndex) {
                                    loadChallenge(challengeState.currentChallengeIndex + 1);
                                } else {
                                    messageArea.textContent = "Â¡Has completado todos los retos de hoy!"
                                }
                            };
                        }
                    }, 500);
                }
            }
        }

        // --- LÃ“GICA DE JUEGO ---
        function startNewPuzzle() {
            game = new Chess(puzzles[Math.floor(Math.random() * puzzles.length)].fen);
            messageArea.textContent = 'Juegan las blancas. Â¡Tu turno!';
            selectedSquare = null;
            drawBoardFromFen(game.fen());
            updateTurnIndicator();
        }

        function updateTurnIndicator() {
            if (!game) return;
            if (game.game_over()) {
                gameInfo.innerHTML = `<span class="turn-indicator bg-red-500">Â¡Juego Terminado!</span>`;
            } else {
                const turn = game.turn() === 'w' ? 'Blancas' : 'Negras';
                const color = game.turn() === 'w' ? 'bg-blue-500' : 'bg-gray-700';
                gameInfo.innerHTML = `<span class="turn-indicator ${color}">Turno de: ${turn}</span>`;
            }
        }

        async function getAiMove() {
            updateTurnIndicator();
            geminiOutput.classList.remove('hidden');
            geminiContent.classList.add('hidden');
            geminiLoading.classList.remove('hidden');
            const fen = game.fen();
            const possibleMoves = game.moves();

            if (possibleMoves.length === 0) { updateTurnIndicator(); return; }

            let retries = 3;
            let moveMade = false;

            while (retries > 0 && !moveMade) {
                const prompt = `Eres un tutor de ajedrez amable y divertido para un niÃ±o de 10 aÃ±os. Juegas con las piezas negras. Es tu turno. La posiciÃ³n actual en FEN es: "${fen}". Los movimientos legales que puedes hacer son: ${possibleMoves.join(', ')}.
                1. Elige tu mejor movimiento de la lista de movimientos legales y escrÃ­belo en notaciÃ³n SAN (ej. "Nf6", "Qxg2").
                2. En una nueva lÃ­nea, explica tu movimiento de forma muy simple, corta y animada.
                Formatea tu respuesta exactamente asÃ­:
                MOVIMIENTO: [Tu movimiento en SAN]
                EXPLICACIÃ“N: [Tu explicaciÃ³n]`;

                try {
                    const apiKey = "";
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: prompt }] }] }) });
                    if (!response.ok) throw new Error('API Error');
                    
                    const result = await response.json();
                    const text = result.candidates[0].content.parts[0].text;
                    const moveMatch = text.match(/MOVIMIENTO: (.*)/);
                    const explanationMatch = text.match(/EXPLICACIÃ“N: (.*)/s);
                    const aiMoveSAN = moveMatch ? moveMatch[1].trim() : null;
                    const explanation = explanationMatch ? explanationMatch[1].trim() : "Â¡Veamos quÃ© tal esto!";
                    geminiContent.innerHTML = explanation.replace(/\n/g, '<br>');
                    if (aiMoveSAN && game.move(aiMoveSAN, { sloppy: true })) {
                        moveMade = true;
                    } else { retries--; }
                } catch (error) { retries--; }
            }

            if (!moveMade) {
                geminiContent.innerHTML = "Â¡Vaya! Me he liado un poco, pero aquÃ­ va mi jugada.";
                const randomMove = possibleMoves[Math.floor(Math.random() * possibleMoves.length)];
                game.move(randomMove);
            }

            drawBoardFromFen(game.fen());
            geminiLoading.classList.add('hidden');
            geminiContent.classList.remove('hidden');
            updateTurnIndicator();
        }

        // --- EVENTOS ---
        modeSelector.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;

            if (button.id === 'practice-mode-button' && !currentUser) {
                dialogTitle.textContent = 'FunciÃ³n Bloqueada';
                dialogMessage.textContent = `Necesitas iniciar sesiÃ³n para jugar contra la IA y poner a prueba tus habilidades.`;
                dialogButtons.innerHTML = `<button id="dialog-login-button" class="control-button bg-blue-500 text-white p-3 rounded-lg shadow-md text-xl w-full">Iniciar SesiÃ³n con Google</button>`;
                completionDialog.classList.remove('hidden');
                document.getElementById('dialog-login-button').onclick = () => {
                    pendingActionAfterLogin = () => { button.click(); };
                    signInWithGoogle();
                    completionDialog.classList.add('hidden');
                };
                return;
            }

            currentMode = button.dataset.mode;
            document.querySelectorAll('#mode-selector button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            clearBoard();
            geminiOutput.classList.add('hidden');
            
            lessonsContainer.style.display = 'none';
            practiceContainer.style.display = 'none';
            challengesContainer.style.display = 'none';
            gameInfo.innerHTML = '';

            if (currentMode === 'lessons') {
                lessonsContainer.style.display = 'flex';
                lessonState.piece = pieceOrder[0];
                lessonState.type = 'move';
                loadLesson();
            } else if (currentMode === 'challenges') {
                challengesContainer.style.display = 'flex';
                challengeState.maxChallengeIndex = getDaysSinceStart();
                loadChallenge(challengeState.maxChallengeIndex);
            } else if (currentMode === 'practice') {
                practiceContainer.style.display = 'flex';
                startNewPuzzle();
            }
        });
        
        newPuzzleButton.addEventListener('click', startNewPuzzle);
        prevChallengeButton.addEventListener('click', () => {
            if (challengeState.currentChallengeIndex > 0) {
                loadChallenge(challengeState.currentChallengeIndex - 1);
            }
        });
        nextChallengeButton.addEventListener('click', () => {
            if (challengeState.currentChallengeIndex < challengeState.maxChallengeIndex) {
                loadChallenge(challengeState.currentChallengeIndex + 1);
            }
        });

        boardEl.addEventListener('click', (e) => {
            const clickedSquare = e.target.closest('.square');
            if (!clickedSquare) return;

            if (currentMode === 'lessons') {
                if (!lessonState.inProgress) return;
                
                if (selectedSquare) {
                    const fromSquare = selectedSquare;
                    fromSquare.querySelector('.piece')?.classList.remove('selected');
                    selectedSquare = null;
                    if (clickedSquare.classList.contains('highlight') && clickedSquare !== fromSquare) {
                        handleLessonMove(fromSquare, clickedSquare);
                    }
                } else {
                    const pieceEl = clickedSquare.querySelector('.piece');
                    const c = parseInt(clickedSquare.dataset.col);
                    const r = parseInt(clickedSquare.dataset.row);
                    if (pieceEl && c === lessonState.pieceCoords[0] && r === lessonState.pieceCoords[1]) {
                        selectedSquare = clickedSquare;
                        pieceEl.classList.add('selected');
                    }
                }
            } else if (currentMode === 'challenges') {
                 if (!challengeState.inProgress) return;
                 if (selectedSquare) {
                    const fromSquare = selectedSquare;
                    fromSquare.querySelector('.piece')?.classList.remove('selected');
                    document.querySelectorAll('.highlight').forEach(sq => sq.classList.remove('highlight'));
                    selectedSquare = null;
                    handleChallengeMove(fromSquare, clickedSquare);
                 } else {
                    const pieceEl = clickedSquare.querySelector('.piece');
                    if (pieceEl) {
                        selectedSquare = clickedSquare;
                        pieceEl.classList.add('selected');
                        const legalMoves = game.moves({ square: clickedSquare.dataset.square, verbose: true });
                        legalMoves.forEach(move => {
                            document.querySelector(`[data-square="${move.to}"]`).classList.add('highlight');
                        });
                    }
                 }
            } else { // Practice mode
                if (!game || game.game_over() || game.turn() !== 'w') return;

                if (selectedSquare) {
                    const fromSquareId = selectedSquare.dataset.square;
                    const toSquareId = clickedSquare.dataset.square;
                    document.querySelector(`[data-square="${fromSquareId}"]`)?.querySelector('.piece')?.classList.remove('selected');
                    selectedSquare = null;
                    if (fromSquareId !== toSquareId) {
                        const move = game.move({ from: fromSquareId, to: toSquareId, promotion: 'q' });
                        if (move) {
                            drawBoardFromFen(game.fen());
                            if (!game.game_over()) { 
                                gameInfo.innerHTML = `<span class="turn-indicator bg-gray-700">Turno de: Negras</span>`;
                                setTimeout(getAiMove, 500); 
                            } else { 
                                updateTurnIndicator(); 
                            }
                        }
                    }
                } else {
                    const squareId = clickedSquare.dataset.square;
                    const piece = game.get(squareId);
                    if (piece && piece.color === game.turn()) {
                        selectedSquare = clickedSquare;
                        clickedSquare.querySelector('.piece')?.classList.add('selected');
                    }
                }
            }
        });
        
        document.getElementById('close-dialog-button').addEventListener('click', () => {
            completionDialog.classList.add('hidden');
        });
        
        // --- INICIALIZACIÃ“N ---
        function init() {
            createBoard();
            setupAuth();
            document.querySelector('[data-mode="lessons"]').click();
        }
        
        init();

    </script>
</body>
</html>
